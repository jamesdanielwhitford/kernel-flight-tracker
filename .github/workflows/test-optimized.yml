name: Test Optimized Flight Search

on:
  workflow_dispatch: # Manual trigger only for testing
    inputs:
      origin:
        description: 'Origin city'
        required: false
        default: 'Johannesburg'
      destination:
        description: 'Destination city'
        required: false
        default: 'Athens'
      departDate:
        description: 'Departure date'
        required: false
        default: 'June 15, 2026'
      returnDate:
        description: 'Return date'
        required: false
        default: 'June 29, 2026'

permissions:
  contents: write  # Allow pushing commits

jobs:
  test-optimized:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Kernel CLI
        run: npm install -g @onkernel/cli

      - name: Deploy optimized version to Kernel
        env:
          KERNEL_API_KEY: ${{ secrets.KERNEL_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Deploy with environment variables
          kernel deploy flight-search-optimized.ts \
            --env OPENAI_API_KEY="$OPENAI_API_KEY"

      - name: Run optimized flight search
        id: search
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          KERNEL_API_KEY: ${{ secrets.KERNEL_API_KEY }}
        run: |
          ORIGIN="${{ github.event.inputs.origin || 'Johannesburg' }}"
          DESTINATION="${{ github.event.inputs.destination || 'Athens' }}"
          DEPART_DATE="${{ github.event.inputs.departDate || 'June 15, 2026' }}"
          RETURN_DATE="${{ github.event.inputs.returnDate || 'June 29, 2026' }}"

          echo "üöÄ Testing optimized search: $ORIGIN ‚Üí $DESTINATION"
          echo "üìÖ Dates: $DEPART_DATE to $RETURN_DATE"

          # Invoke the optimized Kernel action
          set +e  # Don't exit on error
          kernel invoke flight-search-optimized search-flights \
            --payload "{\"origin\": \"$ORIGIN\", \"destination\": \"$DESTINATION\", \"departDate\": \"$DEPART_DATE\", \"returnDate\": \"$RETURN_DATE\"}" \
            --output json > output.jsonl 2>&1
          INVOKE_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          echo "Exit code: $INVOKE_EXIT_CODE"
          echo "Output:"
          cat output.jsonl || echo "No output file"

          # Extract the final invocation_state event
          FINAL_EVENT=$(grep '"event":"invocation_state"' output.jsonl | grep '"status":"succeeded"' | tail -1)

          if [ -z "$FINAL_EVENT" ]; then
            echo "‚ö†Ô∏è No successful invocation found"
            # Try to find error information
            ERROR_EVENT=$(grep '"event":"invocation_state"' output.jsonl | grep '"status":"failed"' | tail -1)
            if [ -n "$ERROR_EVENT" ]; then
              RESULT=$(echo "$ERROR_EVENT" | jq -r '.invocation.output // "{\"error\": \"Failed invocation\"}"')
            else
              RESULT='{"error": "No invocation found"}'
            fi
          else
            RESULT=$(echo "$FINAL_EVENT" | jq -r '.invocation.output // "{\"error\": \"No output field\"}"')
          fi

          echo "search_results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "invoke_exit_code=$INVOKE_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Display results
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.search.outputs.search_results }}' | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create test report
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/optimized-test-$(date +%Y%m%d-%H%M%S).json << 'EOF'
          ${{ steps.search.outputs.search_results }}
          EOF

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
